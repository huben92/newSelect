/*
 * newSelect jQuery plugin: searchable select
 *
 * Copyright 2014 huben92 (http://huben92.wordpress.com)
 *
 * Licensed under the MIT license: http://opensource.org/licenses/MIT
 *
*/

(function(e){var t=false;e.fn.newSelect=function(n){var r=function(n){var r,i,s,o,u,a=e('<div class="__ns" style="width:'+n.width()+'"></div>'),f=e('<div class="__ns_search_container"><input class="__ns_search '+n.attr("class")+'" type="text"></div>'),l=e('<ul class="__ns_options_container options-container"></ul>');var c=function(){if(t===false){var r=e("html head").length>0?e("html head"):e("body");var i='<style type="text/css">.__ns{position:relative;display:inline-block}.__ns_overlay{position:absolute;z-index:2}.__ns_search_container{position:absolute;z-index:3}.__ns_search{margin:1px;width:100%;height:100%;padding:2px}.__ns_options_container{padding:0;background:#fff;width:100%;border-left:#ccc 1px solid;border-right:#ccc 1px solid;border-bottom:#ccc 1px solid;position:absolute;z-index:9999}.__ns_options_container li{list-style:none;max-width:100%;overflow:hidden;padding:0 2px;white-space:nowrap;cursor:pointer;font-family:Arial;font-size:80%}.__ns_options_container li.selected{background:#9CDFFF}.__ns_options_container li.focused{background:#1BA1E2}</style>';if(typeof r!="undefined"){r.append(i)}else{document.write(i)}t=true}n.after(a);n.appendTo(a);a.append('<div class="__ns_overlay"></div>');a.append(f);a.append(l);a.children(".__ns_overlay").css({height:n.height(),width:n.width(),margin:n.css("margin"),padding:n.css("padding"),top:0,left:0});f.css({width:n.width(),height:n.height(),margin:n.css("margin"),padding:n.css("padding"),top:0,left:0,display:"none"});l.css({top:n.height()+1,left:1,margin:n.css("margin"),width:n.width()-2,display:"none"})};var h=function(){i=[];n.find("option").each(function(t,n){var r=s.val==e(this).val()?1:0;i.push({index:t,val:e(this).val(),html:e(this).html(),selected:r})});return i};var p=function(e){if(typeof e=="undefined"||e<0||e>r.length){return null}var t=l.children(".__ns_option").eq(e);if(t.length>0){l.children(".__ns_option").removeClass("focused");t.addClass("focused");o=r[e]}};var d=function(e){if(typeof e=="undefined"||e<0||e>r.length){return null}var t=l.children(".__ns_option").eq(e);if(t.length>0){l.children(".__ns_option").removeClass("selected");t.addClass("selected");s=r[e]}};var v=function(t,n){t.empty();e.each(n,function(n,r){var i=e('<li class="__ns_option option" index="'+r.index+'" val="'+r.val+'" selected="'+r.selected+'">'+r.html+"</li>");i.unbind("click").bind("click",function(t){t.preventDefault();y({index:n,val:e(this).attr("val"),html:e(this).html(),selected:0})}).appendTo(t);if(r.val==o.val&&r.val!="null"){p(n)}if(r.val==s.val&&r.val!="null"){i.addClass("selected")}i.hover(function(){p(n)})});if(t.height()>350){t.css({"max-height":350,"overflow-y":"scroll"})}};var m=function(){n.css({visibility:"visible"});f.hide();l.hide()};var g=function(e){n.css({visibility:"hidden"});r=i;v(l,i);f.show().children(".__ns_search").focus().val(s.html).select();l.show(0,function(){if(typeof e=="function")e();u=l.height()/l.children(".__ns_option:first").height();if(typeof Math.floor!="undefined")u=Math.floor(u)})};var y=function(e){if(e.val=="null"){return null}s=e;o=s;n.val(s.val).trigger("change");m()};var b=function(e,t,n){if(n==""){return e}var r=[];for(var i in e){if(!e.hasOwnProperty(i))continue;if(typeof e[i]=="object"){if(i%1===0){r=r.concat(b(e[i],t,n))}}else{if(typeof e[t]!="undefined"){var s=e[t].toLowerCase().search(n.toLowerCase());if(i==t&&s!=-1){e["sort"]=s;r.push(e)}}}}return r.sort()};var w=function(t){t.unbind("keyup keydown").bind("keyup keydown",function(t){if(t.keyCode==27){t.preventDefault();m();return null}if(t.keyCode==13){t.preventDefault();if(t.type=="keydown"){y(s)}}else if(t.keyCode==36){t.preventDefault();if(t.type=="keydown"){f=0;p(f);d(f);var n=l.children(".__ns_option").eq(f);l.stop(true,false).scrollTop(0)}}else if(t.keyCode==35){t.preventDefault();if(t.type=="keydown"){f=r.length-1;p(f);d(f);var n=l.children(".__ns_option").eq(f);if(n.length>0&&n.offset().top>n.parent().offset().top){var a=n.height()*(f+1);a-=n.parent().height();l.stop(true,false).scrollTop(a)}}}else if(t.keyCode==34){t.preventDefault();if(t.type=="keydown"){var f=r.indexOf(o);f=f+u>r.length-1?r.length-1:f+u;p(f);d(f);var n=l.children(".__ns_option").eq(f);if(n.length>0&&n.offset().top>n.parent().offset().top){var a=n.height()*(f+1);a-=n.parent().height();l.stop(true,false).scrollTop(a)}}}else if(t.keyCode==33){t.preventDefault();if(t.type=="keydown"){var f=r.indexOf(o);f=f-u<0?0:f-u;p(f);d(f);var n=l.children(".__ns_option").eq(f);if(n.length>0&&n.offset().top<n.parent().offset().top){var a=n.height()*f;l.stop(true,false).scrollTop(a)}}}else if(t.keyCode==40){t.preventDefault();if(t.type=="keydown"){var f=r.indexOf(o)+1;p(f);d(f);var n=l.children(".__ns_option").eq(f);if(n.length>0&&n.offset().top>n.parent().offset().top+n.parent().height()-n.height()){var a=n.height()*(f+1);a-=n.parent().height();l.stop(true,false).scrollTop(a)}}}else if(t.keyCode==38){t.preventDefault();if(t.type=="keydown"){var f=r.indexOf(o)-1;p(f);d(f);var n=l.children(".__ns_option").eq(f);if(n.length>0&&n.offset().top<n.parent().offset().top){var a=n.height()*f;l.stop(true,false).scrollTop(a)}}}else{r=b(i,"html",e(this).val());if(typeof r[0]=="undefined"){r[0]={index:0,val:"null",html:e(this).val()+" not found!"}}else{s=r[0];o=s}if(t.keyCode==9){t.preventDefault();if(r[0].val!="null"){e(this).val(r[0].val)}}v(l,r)}})};try{c()}catch(E){console.error("newSelect.1.5: An error occured when initializing newSelect");console.log("newSelect.1.5: Please tell us about this error, so we can fix it in future version");console.log("newSelect.1.5: You can report it by sending email to huben92@gmail.com")}s={index:0,val:n.children(":selected").val(),html:n.children(":selected").html(),selected:1};o=s;try{i=r=h()}catch(E){console.error("newSelect.1.5: An error occured when generating options");console.log("newSelect.1.5: Please tell us about this error, so we can fix it in future version");console.log("newSelect.1.5: You can report it by sending email to huben92@gmail.com")}try{v(l,i)}catch(E){console.error("newSelect.1.5: An error occured when printing options to html");console.log("newSelect.1.5: Please tell us about this error, so we can fix it in future version");console.log("newSelect.1.5: You can report it by sending email to huben92@gmail.com")}try{w(f.children(".__ns_search"))}catch(E){console.error("newSelect.1.5: An error occured when binding event for search options");console.log("newSelect.1.5: Please tell us about this error, so we can fix it in future version");console.log("newSelect.1.5: You can report it by sending email to huben92@gmail.com")}a.children(".__ns_overlay").unbind("click").bind("click",function(e){e.preventDefault();g()});e(document).on("click",function(e){if(!a.is(e.target)&&a.has(e.target).length===0){m()}})};e.each(this,function(){r(e(this))})}})(jQuery)